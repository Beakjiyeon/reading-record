# 13. 검색어 자동완성 시스템
가장 많이 사용된 검색어 k개를 자동완성하여 출력하는 시스템
<br/>

## 1단계. 문제 이해 및 설계 범위 확정
### 기능
- 사용자가 입력하는 단어는 자동완성될 검색어의 첫 부분
- 5개의 자동완성 검색어 제공
- 많이 검색된 순으로
- 맞춤법 검사, 자동 수정은 지원 안함
- 영어. 가능하면 다국어 지원
- 영어 소문자 검색어
- 일간 사용자 천만명
<br/>

### 설계 요구사항
- 빠른 응답 속도 : 시스템 응답 속도는 100밀리초 이내
- 연관성 : 결과가 사용자가 입력한 단어와 연관된 것이어야 함
- 정렬 : 계산은 인기도 등의 순위 모델에 의해 정렬 되어야 한다.
- 규모 확장성 : 많은 트래픽을 감당할 수 있도록 확장 가능해야 한다.
- 고가용성 : 시스템 장애가 발생하거나 느려지거나 네트워크 문제가 생겨도 계속 사용 가능해야 한다.
<br/>


## 2단계. 개략적 설계안 제시 및 동의 구하기
데이터 수집 서비스, 질의 서비스 두 부분으로 나뉜다.
### 데이터 수집 서비스
- 사용자가 입력한 질의를 실시간으로 수집하는 시스템이다.
- 데이터가 많은 애플리케이션엔 바람직하지 않지만 설계안을 만드는 출발점으로는 괜찮다.
- 빈도 테이블 : 질의문과 사용빈도를 저장한다.
<br/>

### 질의 서비스
- 주어진 질의(검색)에 대해 5개의 인기 검색어를 정렬하는 시스템이다.
- 사용자가 검색어를 입력하면 sql top 함수를 통해 빈도 테이블을 조회해온다.
- 데이터 양이 적을 때는 나쁘지 않은 설계안이지만, 데이터가 아주 많아지면 데이터베이스가 병목될 수 있다.
<br/>


## 3단계. 상세 설계
### 트라이 자료구조
- 관계형 데이터베이스를 통해 가장 인기있는 5개 질의문을 조회할 때의 비효율을 해결하는 구조이다.
- 트라이란? 문자열들을 간략하게 저장할 수 있는 자료 구조다.
  - 트리 형태의 자료구조
  - 루트 노드는 빈 문자열을 난타낸다.
  - 각 노드는 글자 하나를 저장하며 26개의 자식 노드를 가질 수 있다.
  - 각 트리노드는 하나의 단어, 또는 접두어 문자열을 나타낸다.
- 기본 트라이 구조는 노드에 문자들을 저장하는데 이용 빈도에 따라 정렬된 결과를 내놓기 위해 노드에 빈도 정보까지 저장한다.
- 용어
  - p: 접두어 길이
  - n: 트라이 안에 있는 노드 개수
  - c: 주어진 노드의 자식 노드 개수
- 검색어가 be 일 때 가장 많이 사용된 질의어 2개 구하기
  1. 접두어 노드 be를 찾는다.
  2. 해당 노드부터 시작하는 하위 트리를 탐색하여 모든 유효 노드를 찾는다.
  3. 유효 노드를 정렬하여 2개만 골라낸다.
  - 시간 복잡도 O(p) + O(c) + O(clogc)
  - 직관적인 알고리즘이지만 최악의 경우, 전체 트라이를 다 검색해야 할 수 있다. 이 문제는 아래 방법으로 보완할 수 있다.
    - 접두어의 최대 길이를 제한 : 
      - 사용자가 검색창에 긴 검색어를 입력하는 일은 겅의 없으므로 p값은 작은 정수값으로 가정한다.
      - 검색어의 최대 길이를 제한 할 수 있다면 접두어 노드를 찾는 단계의 시간 복잡도는 O(작은 상수값=1)로 바뀐다.
    - 각 노드에 인기 검색어를 캐시 :
      - 각 노드에 k개의 인기 검색어를 저장해두면 전체 트라이를 검색할 필요 없다.
      - 하지만 각 노드에 질의어를 저장할 공간이 많이 필요하게 된다.
      - 그러나 빠른 응답속도가 아주 중요할 때는 이 정도 저장공간은 감수할 가치가 있다.
      - 마찬가지로 시간 복잡도가 O(1)로 줄어든다.
<br/>

### 데이터 수집 서비스
- 지금까지 살펴본 설계안은 사용자가 검색창에 뭔가 타이핑을 할 때마다 실시간으로 데이터를 수정했다.
- 이런 방법은 매일 수천만 건의 질의가 입력될 텐데 그때마다 트라이를 갱신하면 질의 서비스는 심각하게 느려지는 문제가 있고
- 일단 트라이가 만들어지고 나면 인기 검색어는 그다지 자주 바뀌지 않을 것이니 트라이는 그렇게 자주 갱신할 필요가 없다.
- 규모 확장이 쉬운 데이터 수집 서비스를 만드려면 데이터가 어디서 오고 어떻게 이용되는 지 알아야 한다.
- 트위터 같은 실시간 서비스가 아니라 구글 검색 같은 서비스는 검색어를 항상 신선하게 유지할 필요가 없다.
- 트라이를 만드는 데 쓰이는 데이터는 보통 분석 서비스나 로깅 서비스로부터 온다.
- 데이터 분석 서비스 로그 - 로그 취합서버 - 취합된 데이터 - 작업 서버 - 트라이 데이터 베이스 - 트라이 캐시
  - 데이터 분석 서비스 로그 : 검색된 원본 데이터와 발생 시각이 저장된다. 
  - 로그 취합 서버 : 대규모의 형식이 제각각인 로그들을 우리의 시스템 형태로 통일한다. (실시간 서비스라면 취합 주기를 짧게 한다.)
  - 취합된 데이터 : 검색된 원본 데이터, 해당 주기 시작 날짜, 해당 주기 동안 검색어의 빈도를 저장한다.
  - 작업 서버(worker) : 주기적으로 비동기 작업을 실행하는 서버 집합인데 트라이 자료구조를 만들고 트라이 데이터베이스에 저장한다.
  - 트라이 캐시 : 분산 캐시 시스템으로 트라이 데이터를 메모리에 유지하여 읽기연산 성능을 높인다. 주기 마다 데이터베이스으이 스냅샷을 떠서 갱신한다.
  - 트라이 데이터베이스 : 지속성 저장소다. 문서 저장소, 키-값 저장소를 데이터베이스로 사용할 수 있다.
    - 문서 저장소 : 새 트라이를 매주(주기) 만들기 때문에 주기적으로 트라이를 직렬화하여 데이터베이스에 저장할 수 있다. 몽고 디비 활용 가능
    - 키-값 저장소 : 트라이에 보관된 모든 접두어를 해시 테이블 키로 변환하고, 각 트라이 노드에 보관된 모든 데이터를 해시 테이블 값으로 변환한다.
       
### 질의 서비스
### 규모 확장이 가능한 저장소
### 트라이 연산


## 4단계. 마무리
