# 14. 유튜브 설계
## 1단계. 문제 이해 및 설계 범위 확정
- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 그리고 안정성
- 지원 클라이언트 : 모바일 앱, 웹 브라우저, 스마트 티비
<br/>

## 2단계. 계략적 설계안 제시 및 동의 구하기
### 컴포넌트 구성
- 단말 : 컴퓨터, 모바일 폰, 스마트 tv를 통해서 유튜브를 시청할 수 있다.
- cdn : 비디오는 cdn에 저장한다. 재생 버튼을 누르면 cdn으로부터 스트리밍이 이루어진다.
- api 서버 : 비디오 스트리밍을 제외한 모든 요청은 api서버가 처리한다. 피드 추천, 비디오 업로드 url 생성, 메타데이터 데이터베이스와 캐시 갱신, 사용자 가입 등등이 api 서버가 처리하는 작업이다.
<br/>

### 비디오 업로드 절차
** 주요 컴포넌트
- 메타데이터 데이터 베이스 : 비디오의 메타 데이터를 보관한다. 샤딩, 다중화를 적용하여 성능 및 가용성 요구사항을 충족한다.
- 메타데이터 캐시 : 성능을 높이기 위해 비디오 메타데이터와 사용자 객체를 캐시한다.
- 원본 저장소 : 원본 비디오를 보관할 대형 이진 파일 저장소 시스템이다.
- 트랜스코딩 서버 : 비디오 인코딩을 담당한다. 비디오의 포맷을 변환한다. 단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림을 제공하기 위해 필요하다.
- 트랜스코딩 비디오 저장소 : 트랜스코딩이 완료된 비디오를 저장하는 blob 저장소다.
- cdn : 비디오를 캐시하는 역할이다. 사용자가 재생버튼을 누르면 비디오 스트리밍은 cdn을 통해 이뤄진다.
- 트랜스코딩 완료 큐 : 비디오 트랜스코딩 완료 이벤트를 보관할 메세지 큐다
- 트랜스코딩 완료 핸들러 : 트랜스 코딩 완료 큐에서 이벤트 데이터를 꺼내어 메타데이터 캐시와 데이터베이스를 갱신할 작업 서버들이다.

** 프로세스 : 비디오 업로드, 메타데이터(비디오 url, 크기, 해상도, 포맷, 사용자 정보가 포함된다.) 갱신 2가지가 병렬적으로 수행된다.
- 비디오 업로드
  1. 비디오를 원본 저장소에 업로드
  2. 트랜스 코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스 코딩을 시작
  3. 트랜스 코딩이 완료되면 두 절차가 병렬적으로 수행
  4. 완료된 비디오를 트랜스 코딩 비디오 저장소로 업로드
  5. 트랜스 코딩 완료 이벤트를 트랜스 코딩 완료 큐에 넣는다. (트랜스 코딩 끝난 비디오를 cdn에 올린다. 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다. 완료핸들러가 메타데이터 데이터베이스와 캐시를 갱신한다.)
  6. api 서버가 단말기에 비디오 업로드가 끝나서 스트리밍 준비가 되었는지 알린다.
- 메타데이터 갱신
  - 원본 저장소에 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 api 서버에 보낸다.
  - api 서버는 이 정보로 메타데이터 캐시와 데이터베이스를 업데이트한다.
<br/>
  
### 비디오 스트리밍 절차
- 스트리밍 프로토콜 : 비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신방법
- mpec-dash, hls, 스무드 스트리밍, 어도비 http 동적 스트리밍 등이 많이 쓰인다.
- 프로토콜마다 지원하는 비디오 인코딩이 다르고 플레이어도 다르다.
- 비디오는 cdn에서 바로 스트리밍 된다. 사용자 단말에 가장 가까운 cdn 에지 서버가 비디오 전송을 담당할 것이다. 
<br/>


## 3단계. 상세 설계
### 비디오 트랜스 코딩
- 비디오를 녹화화면 단말은 해당 비디오를 특정 포맷으로 저장한다.
- 이 비디오가 다른 단말에서도 잘 재생되려면 다른 단말과 호환되는 비트레이트와 포맷으로 저장되어야 한다.
- 비디오 트랜스 코딩이 중요한 이유
  - 가공되지 않은 원본 비디오는 저장공간을 많이 차지한다.
  - 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원한다. 호환성 문제를 해결하려면 여러 포맷 인코딩이 필요하다.
  - 끊김없는 고화질 비디오를 위해, 네트워크 대역폭이 충분하지 않은 사용자에겐 저화질 비디오를 내보내는 것이 바람직하다.
  - 모바일 단말의 경우 네트워크 상황이 수시로 달라질 수 있다. 비디오 화질을 자동/수동 모두 변경할 수 있도록 하는게 좋다.
  - 인코딩 포맷은 다양하지만 대부분 두 부분으로 되어 있다.
    - 컨테이너 : 비디오 파일, 오디오, 메타데이터를 담는 바구니같은 것. 컨테이너 포맷은 avi, mov, mp4 등
    - 코덱 : 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축, 압축해제 알고리즘.
<br/>

### 유향 비순환 그래프 dag 모델
- 비디오 트랜스 코딩은 컴퓨팅 자원, 시간을 많이 소모한다.
- 사용자마다 원하는 비디오 프로세싱 파이프라인이 다르므로 dag모델을 도입하여 유연성, 병렬성을 높인다.
- 원본 비디오는 비디오, 오디오, 메타데이터 세 부분으로 나뉘어 처리된다.
- 비디오에서 처리되는 작업
  - 검사 : 좋은 품질의 비디오인지, 손상은 없는지 확인
  - 비디오 인코딩 : 비이오를 다양한 해상도, 코덱, 비트레이트 조합으로 인코딩하는 작업
  - 썸네일
  - 워터마크
<br/>

### 비디오 트랜스 코딩 아키텍처
- 전처리기
  - 비디오 분할 : 비디오 스트림을 GOP 단위로 쪼갠다. 하나의 GOP는 독립적으로 재생 가능하며, 길이는 몇 초 정도다. 오래된 단말, 브라우저는 비디오 분할을 지원하지 않는데 이런 경우 전처리기가 비디오 분할을 한다.
  - DAG 생성 : 클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG를 만들어 낸다.
  - 데이터 캐시 : 전처리기는 GOP와 메타데이터를 임시저장소에 보관한다. 비디오 인코딩이 실패하면 시스템은 이렇게 보관된 데이터를 활용해 인코딩을 재개한다.
- DAG 스케줄러
  - DAG 그래프를 몇 개 단개로 분할한 다음에 그 각각을 자원 관리자의 작업 큐에 넣는다. 
- 자원관리자
  - 3개의 큐와 작업 스케줄러로 구성된다.
  - 작업 큐 : 실행할 작업이 보관되어 있는 우선순위 큐
  - 작업 서버 큐 : 작업 서버의 가용 상태 정보가 보관되어 있는 우선순위 큐
  - 실행 큐 : 현재 실행중인 작업 및 작업 정보가 보관되어 있는 큐
  - 작업 스케줄러 : 최적의 작업/서버 조합을 골라, 해당 작업 서버가 작업을 수행하도록 지시하는 역할을 담당한다.
  - 작업 관리자의 동작
    1) 작업 관리자는 작업 큐에서 가장 높은 우선순위의 작업을 꺼낸다.
    2) 작업 관리자는 해당 작업을 실행하기 적합한 작업 서버를 고른다.
    3) 작업 스케줄러는 해당 작업 서버에게 작업 실행을 지시한다.
    4) 작업 스케줄러는 해당 작업이 어떤 서버에게 할당되었는지에 관한 정보를 실행 큐에 넣는다.
    5) 작업 스케줄러는 작업이 완료되면 해당 작업을 실행 큐에서 제거한다. 
- 작업실행서버
  - DAG에 정의된 작업을 수행한다.
  - 작업 종류에 따라 작업 서버도 구분하여 관리한다. 
- 임시저장소
  - 저장할 데이터의 유형, 크기, 이용 빈도, 데이터 유효기간 등에 따라 달라진다.
  - 메타 데이터는 작업 서버가 빈번히 참조하는 정보고 크기도 작으므로 메모리 캐시 적합
  - 비디오 데이터는 Blob 저장소가 바람직하다.
  - 임시저장소에 보관한 데이터는 비디오 프로세싱이 완료되면 삭제한다.
- 인코딩된 비디오
  - 인코딩 파이프라인의 최종 결과물이다. ~.mp4 같은 이름을 가진다.
<br/>

### 시스템 최적화
- 속도 최적화
  - 비디오 병렬 업로드 : 비디오 전부를 한 번에 업로드하지 않고 gop 단위로 분할하여 병렬적으로 업로드하여 속도를 높인다.
  - 업로드 센터를 사용자 근거리에 지정 : cdn을 업로드 센터로 이용
  - 모든 절차를 병렬화 : 메세지 큐를 두면 인코딩 모듈은 다운로드 모듈 작업이 끝나길 기다릴 필요없다. 시스템 결합도가 낮아진다.
- 안정성 최적화
  - 미리 사인된 업로드 url : 허가받은 사용자만이 올바른 장소에 비디오를 업로드할 수 있게 미리 사인된 업로드 url을 이용한다.
  - 비디오 보호 : drm 시스템 도입, aes 암호화, 워터마크
- 비용 최적화 
  - cdn은 비싸다.
  - 인기 비디오는 빈번히 재생되지만 나머지는 거의 보는 사람이 없다.
  - 인기 비디오는 cdn을 통해 재생하되 다른 비디오는 서버를 통해 재생한다.
  - 인기가 별로 없는 비디오는 인코딩할 필요가 없을 수 도 있다. 짧은 비디오라면 필요할 떄 인코딩하면서 재생가능
  - 어떤 비디온는 특정 지역에서만 인기가 높다. 이런 경우 다른 지역에 옮길 필요 없다.
  - cdn을 직접 구축하고 인터넷 서비스 제공자와 제휴한다.
<br/>

### 오류 처리
- 시스템 오류의 종류
  - 회복 가능 오류 : 예시. 비디오 세그먼트를 트랜스코딩하다 실패 >> 재시도하면 해결되지만 계속해서 실패한다면 클라이언트에게 적절한 오류 코드를 반환해야 한다.
  - 회복 불가능 오류 : 예시. 비디오 포맷이 잘못됨  
- 상황 별 오류 해결방법
  - 업로드 오류 : 몇 회 재시도
  - 비디오 분할 오류 : 전체 비디오를 서버로 전송하고 서버가 해당 비디오 분할을 처리하도록 한다.
  - 트랜스 코딩 오류 : 재시도
  - 전처리 오류 : DAG 그래프를 재생성
  - DAG 스케줄러 오류 : 작업을 다시 스케줄링한다.
  - 자원관리자 큐에 장애 발생 : 사본을 이용한다.
  - 작업 서버 장애 : 다른 서버에서 해당 작업 재시도
  - api 서버 장애 : 신규요청은 다른 api 서버로 우회됨
  - 메타데이터 캐시 서버 장애 : 데이터는 다중화되어 있으므로 다른 노드에서 데이터를 여전히 가져올 수 있고, 장애가 난 캐시 서버는 새로운 것으로 교체한다.
  - 메타데이터 데이터베이스 서버 장애 : 주서버가 죽으면 부서버 중 하나를 주서버로 교체한다. 부서버가 죽으면 다른 부서버를 통해 읽기 연산을 처리하고 죽은 서버는 새것으로 교체한다.
<br/>

## 4단계. 마무리
더 논의해 볼 만한 주제
- api 계층 규모 확장성 확보 방안 : 무상태서버의 수평적 규모확장 가능함을 어필
- 데이터베이스 계층의 규모 확장성 확보 방안 : 데이터베이스의 다중화와 샤딩 방법
- 라이브 스트리밍 : 비디오를 실시간으로 녹화하고 방송하는 절차를 의미하는데 이번 챕터에선 비-라이브스트리밍 서비스다.
  - 라이브 스트리밍의 경우에는 응답 지연시간이 더 낮아야 하므로 스트리밍 프로토콜 선정에 유의해야 함
  - 라이브 스트리밍의경우 병렬화 필요성은 떨어질 텐데, 작은단위의 데이터를 실시간으로 빨리 처리해야 하기 때문이다.
  - 라이브 스트리밍의 경우 시간이 너무 많이 걸리는 오류처리방법은 사용하기 어렵다.
- 비디오 삭제 : 저작권을 위반, 선정적, 불법적 행위 비디오는 내려야 한다. 업로드 과정에서 식별할 수 있지만 사용자의 신고 절차를 통해 판별할 수 있다.
<br/>
