# 5. 안정 해시 설계
- 수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요한 데 이 목표를 달성할 때 보편적으로 쓰이는 기술이다. 
<br/>

### 해시 키 재배치 문제
- n개의 캐시 서버가 있을 때 부하를 균등히 나누기 위해 hash(key) % 서버의 수 함수를 쓰는 방법의 문제
- 장점 : 서버 풀의 크기가 고정되어 있을 때, 데이터 분포가 균등할 때는 잘 동작한다.
- 단점 : 서버 추가, 삭제시 문제가 발생한다. 대규모 캐시 미스가 발생할 수 있다.
<br/>


### 안정 해시
- 해시 키 재배치 문제를 효과적으로 해결하는 기술이다.
- 기본 구현법
  - 어떤 키가 저장되는 서버는, 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫번 째 서버다.
  - 서버 추가, 삭제 시 키 가운데 일부만 재배치하면 된다. 
  - 문제 : 서버 추가, 삭제 상황을 감안하면 파티션의 크기(인접한 서버 사이의 해시공간)를 균등하게 유지하는 게 불가능하다. 서버별로 가지는 데이터 양에 차이가 생기는 균등 분포를 달성 실패 문제가 있다.
- 가상 노드법 (복제)
  - 가상 노드 : 실제 노드 또는 서버를 가리키는 노드다. 
  - 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다.
  - 서버 x0를 링에 배치하는 대신, x0_0, x0_1, x0_2 3개의 가상 노드를 사용한다.
  - 가상 노드의 개수를 늘리면 분포는 점점 더 균등해진다. 그러나 가상 노드 데이터를 저장할 공간을 더 많이 필요하게 된어 트레이드 오프가 필요하다. 시스템 요구사항에 맞게 개수를 적절히 조절해야 한다.
<br/>


### 왜 사용하는가
- 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화된다.
- 데이터가 보다 균등하게 분포하게 되어 수평적 규모 확장성을 달성하기 쉽다.
- 핫스팟 키 문제를 줄인다. 특정한 샤드에 대한 접근이 지나치게 빈번하면 서버 과부화 문제가 생길 수 있다. (연예인 이름 한 샤드에 몰린 경우)
<br/>


### 쓰이는 곳
- 아마존 다이나모 디비의 파티셔닝 관련 컴포넌ㄴ트
- 아파치 카산드라 클러스터에서의 데이터 파티셔닝
- 디스코드 채팅 어플리케이션
- 아카마이 cdn
- 매그레프 네트워크 부하분산기
<br/>
